#Use an Ubuntu 18.04 base for our staging server
FROM vm/ubuntu:18.04

# To note: Layerfiles create entire VMs, *not* containers!

# Install php5 & composer
RUN sudo apt install php7.2-common php7.2-cli php7.2-gd php7.2-mysql php7.2-curl php7.2-intl php7.2-mbstring php7.2-bcmath php7.2-imap php7.2-xml php7.2-zip
RUN curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer

# Install laravel
ENV COMPOSER_ALLOW_SUPERUSER=1 PATH=~/.config/composer/vendor/bin:$PATH
RUN composer global require laravel/installer

# Run app
COPY . .

# Get the .env file, added by webapp.io from the secrets page
SECRET ENV ENV_FILE
RUN echo "$ENV_FILE" | base64 -d > ~/.env

RUN composer install

RUN php artisan key:generate

RUN BACKGROUND php artisan serve --host 0.0.0.0 --port 80

# Expose website creates a unique link to view the website running in the server
EXPOSE WEBSITE http://localhost:80